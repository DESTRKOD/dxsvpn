<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>DxS VPN ‚Äî –í—Ö–æ–¥</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
      font-family: 'Google Sans', system-ui, sans-serif; 
      background: linear-gradient(135deg, #f0f4ff 0%, #e6ecff 100%); 
      color: #0f1a3a; 
      min-height: 100vh;
      height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      touch-action: pan-y;
      -webkit-overflow-scrolling: touch;
      -webkit-tap-highlight-color: transparent;
    }
    .container { 
      min-height: 100vh;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      padding: 20px 16px; 
    }
    .lottie-container { 
      width: min(160px, 35vw); 
      height: min(160px, 35vw); 
      margin-bottom: clamp(16px, 3vh, 24px); 
      filter: drop-shadow(0 8px 24px rgba(26,115,232,0.24)); 
    }
    h1 { 
      font-size: clamp(24px, 6vw, 28px); 
      font-weight: 600; 
      text-align: center; 
      margin-bottom: clamp(20px, 4vh, 28px); 
      line-height: 1.3; 
    }
    .input-group { 
      width: 100%; 
      max-width: 380px; 
      margin-bottom: 12px; 
    }
    .phone-row { 
      display: flex; 
      align-items: stretch; 
      border: 2px solid #d2e0ff; 
      border-radius: 14px; 
      overflow: hidden; 
      background: white; 
      width: 100%;
    }
    .phone-row:focus-within { 
      border-color: #4285f4; 
      box-shadow: 0 0 0 3px rgba(66,133,244,0.12); 
    }
    .country-select-wrapper { 
      position: relative; 
      flex: 0 0 92px; 
      border-right: 1px solid #e0eaff; 
      background: #f8fbff; 
    }
    .country-select { 
      appearance: none; 
      border: none; 
      padding: 0 32px 0 12px; 
      font-size: 16px; 
      background: transparent; 
      cursor: pointer; 
      height: 100%; 
      width: 100%; 
      text-align: center; 
      outline: none;
    }
    .flag { 
      position: absolute; 
      right: 8px; 
      top: 50%; 
      transform: translateY(-50%); 
      font-size: 18px; 
      pointer-events: none; 
    }
    .number-input { 
      flex: 1; 
      border: none; 
      padding: 14px 16px; 
      font-size: 16px; 
      outline: none; 
      width: 100%;
    }
    input[type="tel"]::-webkit-outer-spin-button, 
    input[type="tel"]::-webkit-inner-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    .input-field {
      width: 100%;
      padding: 14px 16px;
      font-size: 16px;
      border: 2px solid #d2e0ff;
      border-radius: 14px;
      outline: none;
      background: white;
      transition: all 0.2s;
    }
    .input-field:focus {
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66,133,244,0.12);
    }
    .otp-container {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 24px 0;
      max-width: 380px;
    }
    .otp-input {
      width: 48px;
      height: 56px;
      text-align: center;
      font-size: 24px;
      font-weight: 600;
      border: 2px solid #d2e0ff;
      border-radius: 12px;
      background: white;
      outline: none;
      transition: all 0.2s;
    }
    .otp-input:focus {
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66,133,244,0.12);
    }
    .btn { 
      width: 100%; 
      max-width: 380px; 
      padding: 16px; 
      font-size: 18px; 
      font-weight: 600; 
      color: white; 
      background: linear-gradient(145deg, #4285f4, #1967d2); 
      border: none; 
      border-radius: 14px; 
      box-shadow: 0 8px 24px rgba(66,133,244,0.3); 
      cursor: pointer; 
      transition: all 0.2s; 
      margin-top: 16px;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active { 
      transform: scale(0.97); 
      opacity: 0.9;
    }
    .btn:disabled { 
      opacity: 0.6; 
      transform: none; 
      box-shadow: none; 
      cursor: not-allowed; 
    }
    .message { 
      font-size: 15px; 
      text-align: center; 
      margin-top: 16px; 
      line-height: 1.4; 
      opacity: 0; 
      transition: opacity 0.3s; 
      white-space: pre-line; 
      width: 100%;
      max-width: 380px;
    }
    .message.visible { 
      opacity: 1; 
    }
    .message.success { 
      color: #188038; 
    }
    .message.error { 
      color: #d93025; 
    }
    .link {
      text-align: center;
      margin-top: 24px;
      font-size: 15px;
      color: #5f6c8a;
    }
    .link a {
      color: #4285f4;
      text-decoration: none;
      font-weight: 500;
    }
    @media (max-width: 380px) {
      .country-select-wrapper { flex: 0 0 80px; }
      .country-select { padding: 0 28px 0 8px; font-size: 15px; }
      .flag { right: 6px; font-size: 16px; }
      .number-input, .input-field, .otp-input { padding: 12px; font-size: 15px; }
      .otp-input { width: 42px; height: 50px; font-size: 22px; }
    }
  </style>
</head>
<body>

<div class="container">
  <div id="loginBlock">
    <div class="lottie-container">
      <lottie-player src="./registration.json" background="transparent" speed="0.9" loop autoplay></lottie-player>
    </div>

    <h1>–í—Ö–æ–¥</h1>

    <div class="input-group">
      <div class="phone-row">
        <div class="country-select-wrapper">
          <select class="country-select" id="countryCode">
            <option value="+7" data-flag="üá∑üá∫" selected>+7</option>
            <option value="+1" data-flag="üá∫üá∏">+1</option>
            <option value="+44" data-flag="üá¨üáß">+44</option>
            <option value="+49" data-flag="üá©üá™">+49</option>
            <option value="+33" data-flag="üá´üá∑">+33</option>
            <option value="+375" data-flag="üáßüáæ">+375</option>
          </select>
          <span class="flag" id="selectedFlag">üá∑üá∫</span>
        </div>
        <input type="tel" id="phoneNumber" class="number-input" placeholder="9991234567" inputmode="numeric" pattern="[0-9]*" autocomplete="tel-national" />
      </div>
    </div>

    <div class="input-group">
      <input type="password" id="password" class="input-field" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password" />
    </div>

    <button class="btn" id="loginBtn">–í–æ–π—Ç–∏</button>

    <div class="message" id="loginMsg"></div>

    <div class="link">
      –ï—â—ë –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="registration.html">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
    </div>
  </div>

  <!-- –ë–ª–æ–∫ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ (6 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π) -->
  <div id="verifyBlock" style="display:none;">
    <div class="lottie-container">
      <lottie-player src="./registration.json" background="transparent" speed="0.9" loop autoplay></lottie-player>
    </div>
    <h1>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h1>
    <p style="text-align:center; color:#5f6c8a; margin:16px 0;">–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ Telegram</p>
    
    <div class="otp-container">
      <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]*" id="otp1" autofocus>
      <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]*" id="otp2">
      <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]*" id="otp3">
      <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]*" id="otp4">
      <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]*" id="otp5">
      <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]*" id="otp6">
    </div>

    <button class="btn" id="verifyBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    <div class="message error" id="verifyError"></div>
  </div>
</div>

<script>
  const API_URL = 'https://vpnbackend.onrender.com';

  // –≠–ª–µ–º–µ–Ω—Ç—ã –≤—Ö–æ–¥–∞
  const countrySelect = document.getElementById('countryCode');
  const selectedFlag = document.getElementById('selectedFlag');
  const phoneNumber = document.getElementById('phoneNumber');
  const passwordInput = document.getElementById('password');
  const loginBtn = document.getElementById('loginBtn');
  const loginMsg = document.getElementById('loginMsg');

  // OTP
  const otpInputs = [
    document.getElementById('otp1'),
    document.getElementById('otp2'),
    document.getElementById('otp3'),
    document.getElementById('otp4'),
    document.getElementById('otp5'),
    document.getElementById('otp6')
  ];

  let currentPhone = '';

  // –§–ª–∞–≥ —Å—Ç—Ä–∞–Ω—ã
  countrySelect.addEventListener('change', () => {
    const opt = countrySelect.options[countrySelect.selectedIndex];
    selectedFlag.textContent = opt.dataset.flag || 'üåç';
  });

  // –¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
  phoneNumber.addEventListener('input', e => e.target.value = e.target.value.replace(/\D/g, ''));

  // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –∏ –ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É OTP –ø–æ–ª—è–º–∏
  otpInputs.forEach((input, index) => {
    input.addEventListener('input', e => {
      if (e.target.value.length === 1 && index < 5) {
        otpInputs[index + 1].focus();
      }
    });
    input.addEventListener('keydown', e => {
      if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
        otpInputs[index - 1].focus();
      }
    });
  });

  function getOtpCode() {
    return otpInputs.map(i => i.value).join('');
  }

  function showMessage(text, isError = false) {
    loginMsg.textContent = text;
    loginMsg.style.color = isError ? '#d93025' : '#188038';
    loginMsg.classList.add('visible');
  }

  function getFullPhone() {
    return countrySelect.value + phoneNumber.value.trim();
  }

  // –í—Ö–æ–¥
  loginBtn.addEventListener('click', async () => {
    const numPart = phoneNumber.value.trim();
    const pass = passwordInput.value.trim();
    currentPhone = getFullPhone();

    if (numPart.length < 9) return showMessage('–ù–æ–º–µ—Ä —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π', true);
    if (!pass) return showMessage('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å', true);

    loginBtn.disabled = true;
    loginBtn.textContent = '–í—Ö–æ–¥...';

    try {
      const res = await fetch(`${API_URL}/api/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: currentPhone, password: pass })
      });
      const data = await res.json();

      if (data.success) {
        document.getElementById('loginBlock').style.display = 'none';
        document.getElementById('verifyBlock').style.display = 'block';
        showMessage('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram', false);
      } else {
        showMessage(data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ –ø–∞—Ä–æ–ª—å', true);
        loginBtn.disabled = false;
        loginBtn.textContent = '–í–æ–π—Ç–∏';
      }
    } catch {
      showMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', true);
      loginBtn.disabled = false;
      loginBtn.textContent = '–í–æ–π—Ç–∏';
    }
  });

  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–¥–∞
  document.getElementById('verifyBtn').addEventListener('click', async () => {
    const code = getOtpCode();
    if (code.length !== 6) {
      document.getElementById('verifyError').textContent = '–í–≤–µ–¥–∏—Ç–µ –≤—Å–µ 6 —Ü–∏—Ñ—Ä';
      return;
    }

    try {
      const res = await fetch(`${API_URL}/api/login/verify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: currentPhone, code })
      });
      const data = await res.json();

      if (data.success) {
        localStorage.setItem('accessToken', data.accessToken);
        localStorage.setItem('refreshToken', data.refreshToken);
        document.getElementById('verifyError').textContent = '';
        alert('–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...');
        window.location.href = 'main.html';
      } else {
        document.getElementById('verifyError').textContent = data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥';
      }
    } catch {
      document.getElementById('verifyError').textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
    }
  });
</script>
</body>
</html>